---
title: "进程与线程"
date: 2025-11-12T21:41:11-08:00
---

# 进程与线程

1.进程

// 改进的数据结构：添加原子标志
typedef struct {
    float temperature;
    char status[20];
    volatile bool update_pending;  // 原子标志（使用volatile确保可见性）
} GuiData_t;

GuiData_t shared_data;
SemaphoreHandle_t dataMutex;  // 保护共享数据的互斥锁

// 安全更新：MessageHandlerTask
void MessageHandlerTask(void* pvParameters) {
    GuiMessage_t msg;
    
    while(1) {
        xQueueReceive(guiQueue, &msg, portMAX_DELAY);
        
        xSemaphoreTake(dataMutex, portMAX_DELAY);
        
        // 1. 准备新数据
        shared_data.temperature = msg.temp;
        strcpy(shared_data.status, "Updated");
        
        // 2. 原子性地设置更新标志（最后一步）
        shared_data.update_pending = true;
        
        xSemaphoreGive(dataMutex);
    }
}

// 安全读取：GuiRenderTask
void GuiRenderTask(void* pvParameters) {
    while(1) {
        xSemaphoreTake(dataMutex, portMAX_DELAY);
        
        // 仅当更新完成且标志为true时处理
        if(shared_data.update_pending) {
            lv_label_set_text_fmt(tempLabel, "Temp: %.1f", shared_data.temperature);
            lv_label_set_text(statusLabel, shared_data.status);
            
            // 处理完成后清除标志
            shared_data.update_pending = false;
        }
        
        xSemaphoreGive(dataMutex);
        
        lv_task_handler();
        vTaskDelay(pdMS_TO_TICKS(5));
    }
}