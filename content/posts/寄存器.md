---
title: "寄存器"
date: 2025-11-12T21:41:11-08:00
---

|     寄存器分类     |          寄存器名称           |   寄存器编号/别名    |                           主要作用                           |          任务切换中的关键作用          |
| :----------------: | :---------------------------: | :------------------: | :----------------------------------------------------------: | :------------------------------------: |
|   **通用寄存器**   |             R0-R7             |       低寄存器       |           存储函数参数（R0-R3）、返回值、临时数据            |   保存/恢复任务的临时数据和局部变量    |
|   **通用寄存器**   |            R8-R12             |       高寄存器       |                  存储局部变量和中间计算结果                  |   保存/恢复任务的临时数据和局部变量    |
|   **通用寄存器**   |              R13              |    堆栈指针（SP）    |         指向当前堆栈的栈顶，用于`PUSH`、`POP`等操作          |  保存/恢复任务堆栈指针（区分MSP/PSP）  |
|   **通用寄存器**   |              R14              |   链接寄存器（LR）   | 保存子程序的返回地址；异常返回时存储特殊值（如`0xFFFFFFF9`） |   保存/恢复函数返回地址或异常返回值    |
|   **通用寄存器**   |              R15              |   程序计数器（PC）   |                  存储下一条要执行的指令地址                  |        保存/恢复任务的断点地址         |
|   **特殊寄存器**   |     程序状态寄存器（PSR）     |          无          | 拆分为APSR（条件标志位）、IPSR（中断编号）、EPSR（执行状态） |       保存/恢复标志位和执行状态        |
|   **特殊寄存器**   |       主堆栈指针（MSP）       |         R13          |           系统默认堆栈，用于复位处理、中断服务程序           |       保存/恢复系统默认堆栈指针        |
|   **特殊寄存器**   |      进程堆栈指针（PSP）      |         R13          |            任务独立堆栈，通过`CONTROL`寄存器切换             |       保存/恢复任务独立堆栈指针        |
|   **特殊寄存器**   |     控制寄存器（CONTROL）     |          无          |    位0（nPRIV）：特权/用户模式；位1（SPSEL）：选择MSP/PSP    | 决定任务运行的特权级别和使用的堆栈指针 |
| **系统控制寄存器** | 中断控制及状态寄存器（ICSR）  |          无          | 触发PendSV异常（PENDSVSET位）、清除SysTick挂起位（PENDSTCLR） |            触发任务切换异常            |
| **系统控制寄存器** |     系统定时器（SysTick）     | STK_CTRL、STK_LOAD等 |                  提供系统时基，用于任务调度                  |         实现任务时间片轮转调度         |
| **系统控制寄存器** |          NVIC寄存器           |   ISER、ICER、IP等   |             管理外设中断的使能、优先级和挂起状态             |    配置中断优先级，影响任务抢占顺序    |
| **系统控制寄存器** |           MPU寄存器           | MPU_TYPE、MPU_CTRL等 |                 定义内存区域的访问权限和属性                 |    保护任务间的内存隔离，增强安全性    |
| **调试相关寄存器** | 调试异常和监控寄存器（DEMCR） |          无          |    使能调试跟踪（TRCENA位）、触发内核复位（VC_CORERESET）    |      辅助调试，无直接任务切换作用      |
| **调试相关寄存器** | 数据观察点和跟踪寄存器（DWT） |       CYCCNT等       |         周期计数器（记录CPU时钟周期），用于性能分析          |    辅助性能分析，无直接任务切换作用    |



# FreeRTOS任务切换流程


## 一、任务切换的触发条件

任务切换由以下场景触发：

- 时间片耗尽：当前任务运行时间达到配置的时间片长度（需开启`configUSE_TIME_SLICING`）。
- 任务阻塞：任务调用`vTaskDelay()`、`xQueueReceive()`等函数进入阻塞状态。
- 中断触发：外部中断或系统定时器（SysTick）中断完成后，检测到更高优先级任务就绪。
- 主动让步：任务调用`taskYIELD()`主动放弃CPU使用权。
- 优先级变化：更高优先级任务从阻塞状态转为就绪状态，触发抢占。


## 二、任务切换的完整流程

### 1. 触发上下文保存（硬件与软件协作）

- 当切换条件满足时，FreeRTOS通过设置`SCB->ICSR`寄存器触发PendSV异常（该异常优先级最低，确保当前操作完成后执行）。
- 进入PendSV异常后，硬件自动保存部分寄存器：将`R0-R3`、`R12`、`LR`（链接寄存器）、`PC`（程序计数器）、`xPSR`（程序状态寄存器）压入当前任务的堆栈（由PSP指向）。
- 软件手动保存剩余寄存器：在PendSV异常处理函数中，通过`PUSH {R4-R11}`指令，将未被硬件保存的通用寄存器`R4-R11`压入当前任务的堆栈。
- 更新当前任务的TCB：读取当前堆栈指针（PSP）的值，存入当前任务TCB的`pxTopOfStack`成员，记录上下文的存储位置。


### 2. 调度器选择下一个任务

- 调度器（`vTaskSwitchContext()`函数）被调用，负责从就绪任务列表中选择下一个要运行的任务。
- 调度器首先确定最高优先级（`uxTopPriority`），然后从该优先级对应的就绪列表（`pxReadyTasksLists[uxTopPriority]`）中，通过`listGET_OWNER_OF_HEAD_ENTRY()`函数获取链表头部的任务（即该优先级下最先就绪的任务）。
- 更新全局变量`pxCurrentTCB`，使其指向新选中任务的TCB。


### 3. 恢复下一个任务的上下文

- 从新任务的TCB中读取`pxTopOfStack`成员，获取其堆栈指针（PSP），并通过`MSR PSP, 新PSP值`指令，将PSP更新为新任务的堆栈指针。
- 软件手动恢复寄存器：通过`POP {R4-R11}`指令，从新任务的堆栈中弹出`R4-R11`寄存器的值，恢复这些寄存器的状态。
- 异常返回：执行`BX LR`指令退出PendSV异常，此时硬件自动从新任务的堆栈中弹出`R0-R3`、`R12`、`LR`、`PC`、`xPSR`，恢复这些寄存器的值。
- 任务恢复运行：`PC`寄存器被恢复为新任务被中断时的指令地址，CPU从该地址继续执行新任务，完成切换。


## 三、核心机制说明

- 上下文存储位置：任务的寄存器值（上下文）存储在该任务的独立堆栈中，而非TCB本身；TCB通过`pxTopOfStack`指针记录堆栈中上下文的位置。
- 堆栈隔离：每个任务的堆栈由PSP单独管理，切换时只需更新PSP即可切换堆栈空间，实现任务内存隔离。
- 优先级驱动：始终选择最高优先级的就绪任务运行，相同优先级任务采用时间片轮转（若开启）。


## 四、总结

FreeRTOS任务切换的核心是“保存当前任务上下文→选择下一个任务→恢复新任务上下文”的循环。通过硬件自动保存与软件手动保存结合的方式，确保寄存器状态完整存储；通过调度器从就绪列表中选择任务，保证高优先级任务优先执行；最终通过恢复堆栈中的寄存器值，使新任务无缝接续运行。这一流程实现了多任务的并发执行，是FreeRTOS实时性的核心保障。